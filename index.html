<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Викторина 1001 КРЕПЕЖ</title>
  <style>
    :root{
      --bg: #0b1020;
      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.08);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.68);
      --line: rgba(255,255,255,.12);
      --shadow: 0 12px 40px rgba(0,0,0,.35);
      --radius: 18px;
      --radius2: 14px;
      --pad: 20px;
      --accent: #7c5cff;
      --accent2: #20e3b2;
      --danger: #ff5471;
      --focus: rgba(124,92,255,.35);
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Liberation Sans", sans-serif;
    }

    *{ box-sizing: border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: var(--font);
      color: var(--text);
      background:
        radial-gradient(1200px 900px at 15% 15%, rgba(124,92,255,.25), transparent 55%),
        radial-gradient(900px 700px at 90% 20%, rgba(32,227,178,.18), transparent 60%),
        radial-gradient(700px 500px at 60% 95%, rgba(255,84,113,.12), transparent 60%),
        linear-gradient(180deg, #070a14, var(--bg));
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 22px;
    }

    .app{
      width: min(860px, 100%);
      display:grid;
      gap: 16px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap: 10px;
      user-select:none;
    }
    .logo{
      width: 38px;
      height: 38px;
      border-radius: 12px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow: 0 10px 28px rgba(124,92,255,.25);
      position:relative;
      overflow:hidden;
    }
    .logo::after{
      content:"";
      position:absolute;
      inset:-60%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.55), transparent 40%);
      transform: rotate(18deg);
      opacity:.6;
    }
    .brand h1{
      margin:0;
      font-size: 18px;
      letter-spacing: .2px;
    }
    .brand p{
      margin:0;
      font-size: 12.5px;
      color: var(--muted);
    }

    .chip{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid var(--line);
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
    }
    .chip .dot{
      width: 10px; height: 10px;
      border-radius: 99px;
      background: rgba(32,227,178,.9);
      box-shadow: 0 0 0 4px rgba(32,227,178,.15);
    }
    .chip .t1{
      font-size: 12.5px;
      color: var(--muted);
    }
    .chip .t2{
      font-size: 13px;
      font-weight: 650;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      overflow:hidden;
      max-height: calc(100vh - 44px);
      display: grid;
      grid-template-rows: auto 1fr auto; /* progress / content / footer */
    }

    .progressWrap{
      padding: 14px 16px 10px;
      border-bottom: 1px solid var(--line);
      display:flex;
      align-items:center;
      gap: 14px;
      justify-content:space-between;
    }

    .progressMeta{
      display:flex;
      flex-direction:column;
      gap: 2px;
      min-width: 140px;
    }
    .progressMeta .small{
      font-size: 12.5px;
      color: var(--muted);
    }
    .progressMeta .big{
      font-size: 14px;
      font-weight: 650;
      letter-spacing:.15px;
    }

    .bar{
      flex: 1;
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    .bar > i{
      display:block;
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      border-radius: 999px;
      transition: width .28s ease;
    }

    .content{
      padding: 18px 16px 16px;
      overflow: auto;
      min-height: 0;
    }

    .screen{
      display:none; /* будет переключаться на block */
    }
    .screen.active{
      display:block;
    }

    .hero{
      padding: 10px 4px 2px;
      display:grid;
      gap: 10px;
    }

    .hero h2{
      margin:0;
      font-size: 24px;
      letter-spacing: .2px;
    }
    .hero p{
      margin:0;
      color: var(--muted);
      line-height: 1.5;
      font-size: 14.5px;
      max-width: 62ch;
    }

    .qHeader{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
      margin-bottom: 12px;
    }
    .qTitle{
      margin:0;
      font-size: 18px;
      letter-spacing:.15px;
      line-height: 1.35;
    }
    .qHelp{
      margin:0;
      font-size: 12.5px;
      color: var(--muted);
    }

    .options{
      display:grid;
      gap: 10px;
      margin-top: 10px;
    }

    .opt{
      display:flex;
      align-items:center;
      gap: 12px;
      padding: 12px 12px;
      border-radius: var(--radius2);
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      cursor:pointer;
      transition: transform .05s ease, background .2s ease, border-color .2s ease;
      user-select:none;
    }
    .opt:hover{
      background: rgba(255,255,255,.07);
      border-color: rgba(255,255,255,.18);
    }
    .opt:active{
      transform: translateY(1px);
    }

        .opt input{
    -webkit-appearance: none;
    appearance: none;
    width: 20px;
    height: 20px;
    margin: 0;
    cursor: pointer;

    border: 1px solid rgba(255,255,255,.22);
    background: rgba(255,255,255,.06);
    border-radius: 6px;

    display: grid;
    place-content: center;
    flex: 0 0 20px;
    }

    .opt input::before{
    content: "";
    width: 10px;
    height: 10px;
    transform: scale(0);
    transition: transform .12s ease;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    border-radius: 4px;
    }

    .opt input:checked::before{
    transform: scale(1);
    }

    /* Радио — круглое (если будут single-вопросы) */
    .opt input[type="radio"]{
    border-radius: 999px;
    }
    .opt input[type="radio"]::before{
    border-radius: 999px;
    }

    .opt .label{
      display:flex;
      flex-direction:column;
      gap: 2px;
    }
    .opt .label .main{
      font-size: 14.5px;
      letter-spacing:.1px;
    }
    .opt .label .sub{
      font-size: 12.5px;
      color: var(--muted);
    }

    .footer{
      padding: 14px 16px;
      border-top: 1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }

    .hint{
      font-size: 12.5px;
      color: var(--muted);
    }

    .btnRow{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content:flex-end;
    }

    .btn{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 10px 14px;
      border-radius: 12px;
      font-weight: 650;
      letter-spacing: .15px;
      cursor:pointer;
      transition: transform .05s ease, background .2s ease, border-color .2s ease, opacity .2s ease;
      outline:none;
    }
    .btn:hover{
      background: rgba(255,255,255,.08);
      border-color: rgba(255,255,255,.20);
    }
    .btn:active{
      transform: translateY(1px);
    }
    .btn:focus-visible{
      box-shadow: 0 0 0 4px var(--focus);
    }

    .btn.primary{
      border-color: rgba(124,92,255,.55);
      background: linear-gradient(135deg, rgba(124,92,255,.95), rgba(32,227,178,.75));
      color: #0a1020;
    }
    .btn.primary:hover{
      opacity: .95;
    }
    .btn.ghost{
      background: transparent;
    }
    .btn.danger{
      border-color: rgba(255,84,113,.5);
      background: rgba(255,84,113,.12);
    }
    .btn[disabled]{
      opacity: .45;
      cursor:not-allowed;
      transform:none;
    }

    .resultBox{
      margin-top: 10px;
      padding: 14px 14px;
      border-radius: 16px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
    }
    .resultBig{
      margin:0;
      font-size: 20px;
      font-weight: 800;
      letter-spacing: .15px;
      line-height: 1.25;
    }
    .resultSmall{
      margin: 8px 0 0;
      color: var(--muted);
      line-height: 1.55;
      font-size: 14px;
    }

    .review{
      margin-top: 14px;
      display:grid;
      gap: 10px;
    }
    details{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      border-radius: 14px;
      padding: 10px 12px;
    }
    summary{
      cursor:pointer;
      font-weight: 650;
      color: rgba(255,255,255,.9);
      outline:none;
    }
    .reviewItem{
      margin-top: 10px;
      border-top: 1px solid rgba(255,255,255,.10);
      padding-top: 10px;
      display:grid;
      gap: 6px;
      font-size: 13.5px;
      color: var(--muted);
    }
    .reviewItem b{ color: rgba(255,255,255,.92); }
    .pill{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color: rgba(255,255,255,.85);
      font-size: 12.5px;
      width: fit-content;
    }

    @media (max-width: 520px){
      .qHeader{ flex-direction:column; }
      .progressMeta{ min-width: 120px; }
      .hero h2{ font-size: 22px; }
    }
    .content::-webkit-scrollbar{
      width: 10px;
    }
    .content::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,.16);
      border-radius: 999px;
    }
    .content::-webkit-scrollbar-track{
      background: rgba(255,255,255,.06);
    }
        /* ===== Модалка разборов ===== */
    .modal{
      position: fixed;
      inset: 0;
      display: none;
      z-index: 9999;
    }
    .modal.active{ display:block; }
    
    .modal__backdrop{
      position:absolute;
      inset:0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
    }
    
    .modal__panel{
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: min(920px, calc(100% - 28px));
      max-height: calc(100vh - 28px);
      background: linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.05));
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 18px;
      box-shadow: 0 18px 60px rgba(0,0,0,.45);
      overflow: hidden;
      display: grid;
      grid-template-rows: auto 1fr;
    }
    
    .modal__head{
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }
    
    .modal__title{
      font-weight: 800;
      letter-spacing: .2px;
    }
    .modal__sub{
      margin-top: 2px;
      font-size: 12.5px;
      color: rgba(255,255,255,.68);
    }
    
    .modal__body{
      padding: 14px 16px 18px;
      overflow: auto;
      min-height: 0;
    }
    
    /* аккуратный скроллбар внутри модалки */
    .modal__body::-webkit-scrollbar{ width: 10px; }
    .modal__body::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,.16);
      border-radius: 999px;
    }
    .modal__body::-webkit-scrollbar-track{
      background: rgba(255,255,255,.06);
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Викторина 1001 КРЕПЕЖ</h1>
          <p>Для менеджеров</p>
        </div>
      </div>

      <div class="chip" title="Статус">
        <span class="dot" aria-hidden="true"></span>
        <div>
          <div class="t1">Режим</div>
          <div class="t2" id="modeText">Готово</div>
        </div>
      </div>
    </div>

    <div class="card" role="application" aria-label="Викторина">
      <div class="progressWrap">
        <div class="progressMeta">
          <div class="small" id="progressSmall">Шаг 0 из 10</div>
          <div class="big" id="progressBig">Начало</div>
        </div>
        <div class="bar" aria-label="Прогресс">
          <i id="progressFill"></i>
        </div>
      </div>

      <div class="content">

        <!-- Экран: старт -->
        <section class="screen active" id="screenStart" aria-labelledby="startTitle">
          <div class="hero">
            <h2 id="startTitle">Готовы пройти короткую викторину?</h2>
            <p>
              Вас ждёт 10 вопросов разного типа: одиночный и множественный выбор.
              Набирайте баллы за правильные ответы и в конце посмотрите результат.
            </p>
            <div class="resultBox">
              <p class="resultBig">Подсказка</p>
              <p class="resultSmall">
                Для вопросов с множественным выбором отметьте несколько вариантов и нажмите «Далее».
              </p>
            </div>
                  <div class="resultBox" style="margin-top:14px;">
        <p class="resultBig">Вход</p>
        <p class="resultSmall" style="margin-bottom:10px;">
          Введите имя/фамилию (или табельный номер) — так результат сохранится в общую таблицу.
                </p>
                <input id="userName" placeholder="Например: Иван Петров" style="
                  width:100%;
                  padding:12px 12px;
                  border-radius:12px;
                  border:1px solid rgba(255,255,255,.14);
                  background:rgba(0,0,0,.18);
                  color:rgba(255,255,255,.92);
                  outline:none;
                ">
                </div>
          </div>
        </section>

        <!-- Экран: вопрос -->
        <section class="screen" id="screenQuiz" aria-live="polite">
          <div class="qHeader">
            <div>
              <p class="qHelp" id="qMeta">Вопрос</p>
              <h3 class="qTitle" id="qText">—</h3>
            </div>
            <div class="pill" id="qPoints">Баллы: 0</div>
          </div>

          <div class="options" id="options"></div>
        </section>

        <!-- Экран: результат -->
        <section class="screen" id="screenResult" aria-labelledby="resultTitle">
          <div class="hero">
            <h2 id="resultTitle">Готово!</h2>

            <div class="resultBox">
              <p class="resultBig" id="resultLine">Вы набрали X из Y возможных баллов!</p>
              <p class="resultSmall" id="resultHint">
                Хотите попробовать ещё раз? Нажмите «Пройти заново».
              </p>
            </div>
             <div class="review">
              <button class="btn" id="btnOpenReview" type="button">Показать разбор</button>
            </div>
          </div>
        </section>

      </div>

      <div class="footer">
        <div class="hint" id="footerHint">Нажмите «Начать», чтобы перейти к первому вопросу.</div>
        <div class="btnRow">
          <button class="btn ghost" id="btnBack" type="button">Назад</button>
          <button class="btn danger" id="btnReset" type="button">Сброс</button>
          <button class="btn primary" id="btnNext" type="button">Начать</button>
        </div>
      </div>
    </div>
  </div>
   <!-- Модальное окно: разбор ответов -->
    <div class="modal" id="reviewModal" aria-hidden="true">
      <div class="modal__backdrop" data-close="1"></div>
    
      <div class="modal__panel" role="dialog" aria-modal="true" aria-labelledby="reviewModalTitle">
        <div class="modal__head">
          <div>
            <div class="modal__title" id="reviewModalTitle">Разбор ответов</div>
            <div class="modal__sub" id="reviewModalSub">—</div>
          </div>
          <button class="btn ghost" id="btnCloseReview" type="button">Закрыть</button>
        </div>
    
        <div class="modal__body">
          <div id="reviewListModal"></div>
        </div>
      </div>

  <script>
    /**
     * ДАННЫЕ: 5 вопросов разного типа
     * type: "single" | "multi"
     * score: баллы за вопрос (начисляются, если ответ полностью верный)
     * correct: для single — индекс правильного варианта; для multi — массив индексов
     */
     const SHEETS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbx6px8UwSqgtku0Oz4twfJjG31dmkvckIQngpeQOcgUx25C-G6qU__97I0h5FYiXRk/exec";

    const questions = [
      {
        id: 1,
        type: "single",
        text: "Что такое навесная фасадная вентилируемая система (НФС) согласно ГОСТ Р 58883-2020?",
        score: 2,
        options: ["Однослойная облицовка с декоративным покрытием", "Многослойная конструкция с подконструкцией, утеплителем, мембраной и облицовкой с воздушным зазором", "Система штукатурного фасада с армирующей сеткой", "Кирпичная кладка с утеплением изнутри"],
        correct: 1
      },
      {
        id: 2,
        type: "single",
        text: "В чем основное преимущество НВФ перед «мокрыми» фасадными системами?",
        score: 2,
        options: ["Возможность монтажа только летом", "Наличие воздушного зазора, обеспечивающего вентиляцию и вывод конденсата", "Отсутствие необходимости утепления", "Более низкая стоимость материалов"],
        correct: 1
      },
      {
        id: 3,
        type: "multi",
        text: "Какие преимущества характерны для навесных вентилируемых фасадов?",
        score: 4,
        options: ["Снижение затрат на отопление и кондиционирование до 20%", "Срок службы более 50 лет", "Монтаж при температуре до –25 °C", "Полное отсутствие необходимости обслуживания", "Возможность замены отдельных элементов без демонтажа всей системы"],
        correct: [0, 1, 2, 4]
      },
      {
        id: 4,
        type: "multi",
        text: "Какие профили входят в линейку STALMAX для НВФ?",
        score: 4,
        options: ["LFS-PGO — Г-образный горизонтальный", "LFS-PVO-T — Т-образный вертикальный", "LFS-PVO-P — П-образный вертикальный", "LFS-PVM-Z — Z-образный промежуточный", "LFS-KSU — усиленный кронштейн"],
        correct: [0, 1, 2, 3]
      },
      {
        id: 5,
        type: "multi",
        text: "Каковы основные функции паронитовой прокладки LFS-UP?",
        score: 2,
        options: ["Разрыв «мостиков холода»", "Декоративная отделка фасада", "Защита металла от влаги и коррозии", "Увеличение толщины утеплителя"],
        correct: [0, 2]
      },
      {
        id: 6,
        type: "single",
        text: "Какой инструмент допускается использовать при сверлении отверстий в кирпичной кладке?",
        score: 2,
        options: ["Перфоратор", "Электродрель", "Ударная кувалда", "Шуруповерт"],
        correct: 1
      },
    {
        id: 7,
        type: "multi",
        text: "Какие требования предъявляются к монтажу утеплителя?",
        score: 4,
        options: ["Укладка снизу вверх", "Наличие зазоров между плитами для вентиляции", "Монтаж «вразбежку» при двухслойной укладке", "Первичное крепление двумя тарельчатыми дюбелями", "Использование 5–7 дюбелей на плиту"],
        correct: [0, 2, 3, 4]
      },
    {
        id: 8,
        type: "multi",
        text: "Каковы нормативные требования к вентиляционному зазору?",
        score: 2,
        options: ["Минимальный рекомендуемый зазор — 40–60 мм", "Максимальный зазор — 200 мм", "При зазоре более 200 мм необходимы рассечки", "Вентзазор может отсутствовать при использовании мембраны"],
        correct: [0, 1, 2]
      },
    {
        id: 9,
        type: "multi",
        text: "Когда необходимо применять усиленные кронштейны LFS-KSU?",
        score: 2,
        options: ["При облицовке тяжелыми материалами (керамогранит, натуральный камень)", "На высотных зданиях", "В ветронагруженных зонах", "При монтаже композитных панелей малой массы"],
        correct: [0, 1, 2]
      },
    {
        id: 10,
        type: "multi",
        text: "Какие факторы напрямую влияют на долговечность НВФ?",
        score: 2,
        options: ["Правильное проектирование с учетом нагрузок", "Использование качественных комплектующих", "Строгое соблюдение технологии монтажа", "Цвет облицовки"],
        correct: [0, 2]
      },
    ];

    // ====== Состояние приложения ======
    const state = {
      step: 0,                 // 0 = старт, 1..N = вопросы, N+1 = результат
      currentIndex: 0,         // индекс текущего вопроса
      answers: new Array(questions.length).fill(null), // для single: number | null; для multi: number[]
      score: 0,
      userName: ""
    };

    // ====== DOM ======
    const modeText = document.getElementById("modeText");

    const screenStart = document.getElementById("screenStart");
    const screenQuiz = document.getElementById("screenQuiz");
    const screenResult = document.getElementById("screenResult");

    const progressSmall = document.getElementById("progressSmall");
    const progressBig = document.getElementById("progressBig");
    const progressFill = document.getElementById("progressFill");

    const qMeta = document.getElementById("qMeta");
    const qText = document.getElementById("qText");
    const qPoints = document.getElementById("qPoints");
    const optionsEl = document.getElementById("options");

    const footerHint = document.getElementById("footerHint");
    const btnBack = document.getElementById("btnBack");
    const btnReset = document.getElementById("btnReset");
    const btnNext = document.getElementById("btnNext");

    const resultLine = document.getElementById("resultLine");
    const userNameInput = document.getElementById("userName");
    const btnOpenReview = document.getElementById("btnOpenReview");
    const reviewModal = document.getElementById("reviewModal");
    const btnCloseReview = document.getElementById("btnCloseReview");
    const reviewListModal = document.getElementById("reviewListModal");
    const reviewModalSub = document.getElementById("reviewModalSub");

    // ====== Вспомогательные функции ======
    function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

    function showScreen(which){
      // Плавная смена экранов через display none/block (без анимаций transform),
      // как просили в задании.
      const all = [screenStart, screenQuiz, screenResult];
      all.forEach(s => s.classList.remove("active"));
      which.classList.add("active");
    }

    function maxScore(){
      return questions.reduce((sum, q) => sum + (q.score || 0), 0);
    }

    function arraysEqualAsSets(a, b){
      if (!Array.isArray(a) || !Array.isArray(b)) return false;
      const sa = new Set(a);
      const sb = new Set(b);
      if (sa.size !== sb.size) return false;
      for (const v of sa) if (!sb.has(v)) return false;
      return true;
    }

    function isAnswered(index){
      const ans = state.answers[index];
      const q = questions[index];
      if (q.type === "single") return typeof ans === "number";
      if (q.type === "multi") return Array.isArray(ans) && ans.length > 0;
      return false;
    }

        function pointsForQuestion(q, ans){
    // SINGLE: либо весь балл вопроса, либо 0
    if (q.type === "single"){
        return (typeof ans === "number" && ans === q.correct) ? q.score : 0;
    }

    // MULTI: 1 балл (или q.perCorrect) за каждый выбранный правильный
    if (q.type === "multi"){
        const per = Number.isFinite(q.perCorrect) ? q.perCorrect : 1;
        if (!Array.isArray(ans) || ans.length === 0) return 0;

        const correctSet = new Set(q.correct); // q.correct должен быть массивом
        let gained = 0;

        for (const picked of ans){
        if (correctSet.has(picked)) gained += per;
        }

        return Math.min(gained, q.score);
    }

    return 0;
    }
        function calcScore(){
    let total = 0;

    for (let i = 0; i < questions.length; i++){
        const q = questions[i];
        const ans = state.answers[i];

        if (q.type === "single"){
        if (typeof ans === "number" && ans === q.correct) {
            total += q.score;
        }
        continue;
        }

        // multi: 1 балл за каждый выбранный правильный вариант
        if (q.type === "multi"){
        const per = Number.isFinite(q.perCorrect) ? q.perCorrect : 1;

        if (!Array.isArray(ans) || ans.length === 0) continue;

        const correctSet = new Set(q.correct); // q.correct должен быть массивом!
        let gained = 0;

        for (const picked of ans){
            if (correctSet.has(picked)) gained += per;
        }

        // ограничим максимум баллов за вопрос
        gained = Math.min(gained, q.score);

        total += gained;
        }
    }

    state.score = total;
    return total;
    }

    function updateProgress(){
      // step: 0 старт, 1..N вопросы, N+1 результат
      const N = questions.length;
      const step = state.step;

      let small, big, pct;

      if (step === 0){
        small = `Шаг 0 из ${N}`;
        big = "Начало";
        pct = 0;
        modeText.textContent = "Готово";
      } else if (step >= 1 && step <= N){
        small = `Шаг ${step} из ${N}`;
        big = `Вопрос ${step}`;
        pct = (step - 1) / N * 100; // заполнение по мере прохождения
        modeText.textContent = "Прохождение";
      } else {
        small = `Шаг ${N} из ${N}`;
        big = "Результат";
        pct = 100;
        modeText.textContent = "Итог";
      }

      progressSmall.textContent = small;
      progressBig.textContent = big;
      progressFill.style.width = `${clamp(pct, 0, 100)}%`;
    }

    function renderQuestion(){
      const i = state.currentIndex;
      const q = questions[i];

      qMeta.textContent = q.type === "multi"
        ? "Выберите один или несколько вариантов"
        : "Выберите один вариант";

      qText.textContent = q.text;
      qPoints.textContent = `Баллы: ${q.score}`;

      optionsEl.innerHTML = "";

      const saved = state.answers[i];

      q.options.forEach((optText, idx) => {
        const id = `q${q.id}_opt${idx}`;
        const wrapper = document.createElement("label");
        wrapper.className = "opt";
        wrapper.setAttribute("for", id);

        const input = document.createElement("input");
        input.type = (q.type === "multi") ? "checkbox" : "radio";
        input.name = `q_${q.id}`;
        input.id = id;
        input.value = String(idx);

        // восстановление выбранных ответов
        if (q.type === "single" && typeof saved === "number" && saved === idx){
          input.checked = true;
        }
        if (q.type === "multi" && Array.isArray(saved) && saved.includes(idx)){
          input.checked = true;
        }

        input.addEventListener("change", () => {
          if (q.type === "single"){
            state.answers[i] = idx;
          } else {
            const current = Array.isArray(state.answers[i]) ? [...state.answers[i]] : [];
            if (input.checked){
              if (!current.includes(idx)) current.push(idx);
            } else {
              const pos = current.indexOf(idx);
              if (pos !== -1) current.splice(pos, 1);
            }
            state.answers[i] = current.sort((a,b) => a-b);
          }
          syncButtons();
        });

        const labelBox = document.createElement("div");
        labelBox.className = "label";

        const main = document.createElement("div");
        main.className = "main";
        main.textContent = optText;

        labelBox.appendChild(main);

        wrapper.appendChild(input);
        wrapper.appendChild(labelBox);

        optionsEl.appendChild(wrapper);
      });
    }

        function renderResult(){
    const total = calcScore();
    const max = maxScore();
    resultLine.textContent = `Вы набрали ${total} из ${max} возможных баллов!`;

    reviewListModal.innerHTML = "";
    reviewModalSub.textContent = `Результат: ${state.score} / ${maxScore()} (${Math.round((state.score/maxScore())*100)}%)`;

    questions.forEach((q, i) => {
        const ans = state.answers[i];

        // Набранные баллы за вопрос
        const gained = pointsForQuestion(q, ans);

        // Нормализуем выбранные варианты в Set
        const pickedSet = new Set(
        q.type === "single"
            ? (typeof ans === "number" ? [ans] : [])
            : (Array.isArray(ans) ? ans : [])
        );

        // Нормализуем правильные варианты в Set
        const correctSet = new Set(
        q.type === "single"
            ? [q.correct]
            : (Array.isArray(q.correct) ? q.correct : [])
        );

        // Статус
        const status = (() => {
        if (gained === q.score) return "верно ✅";
        if (gained > 0) return "частично ✅";
        return "неверно ❌";
        })();

        // Формируем список вариантов с метками
        const lines = q.options.map((optText, idx) => {
        const picked = pickedSet.has(idx);
        const correct = correctSet.has(idx);

        // ✅ выбран и правильный
        if (picked && correct) return `✅ ${escapeHtml(optText)} <span style="opacity:.7">(вы выбрали, верно)</span>`;
        // ❌ выбран и неправильный
        if (picked && !correct) return `❌ ${escapeHtml(optText)} <span style="opacity:.7">(вы выбрали, неверно)</span>`;
        // ⭐ правильный, но не выбран
        if (!picked && correct) return `⭐ ${escapeHtml(optText)} <span style="opacity:.7">(правильный вариант)</span>`;
        // нейтральный
        return `• ${escapeHtml(optText)}`;
        });

        // Блок на экран
        const div = document.createElement("div");
        div.className = "reviewItem";

        div.innerHTML = `
        <div><b>${i + 1}. ${escapeHtml(q.text)}</b></div>
        <div style="margin-top:6px; display:grid; gap:6px;">
            <div>Статус: <b>${status}</b> · Баллы за вопрос: <b>${gained}/${q.score}</b></div>
            <div style="border-top:1px solid rgba(255,255,255,.10); padding-top:8px; display:grid; gap:6px;">
            ${lines.map(l => `<div>${l}</div>`).join("")}
            </div>
        </div>
        `;

        reviewListModal.appendChild(div);
    });
    }


    function escapeHtml(str){
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function syncButtons(){
      const N = questions.length;

      // Назад доступен, если мы не на старте
      btnBack.disabled = (state.step === 0);

      // Сброс доступен всегда (но на старте он просто очистит ответы)
      btnReset.disabled = false;

      if (state.step === 0){
        btnNext.textContent = "Начать";
        btnNext.disabled = false;
        footerHint.textContent = "Нажмите «Начать», чтобы перейти к первому вопросу.";
      } else if (state.step >= 1 && state.step <= N){
        const i = state.currentIndex;
        const last = (state.step === N);
        btnNext.textContent = last ? "Завершить" : "Далее";

        // запретить идти дальше, если нет ответа на текущий
        const answered = isAnswered(i);
        btnNext.disabled = !answered;

        footerHint.textContent = answered
          ? (last ? "Нажмите «Завершить», чтобы увидеть результат." : "Нажмите «Далее», чтобы перейти к следующему вопросу.")
          : "Сначала выберите ответ, чтобы продолжить.";
      } else {
        btnNext.textContent = "Пройти заново";
        btnNext.disabled = false;
        footerHint.textContent = "Нажмите «Пройти заново», чтобы начать сначала.";
      }
    }

    function goToStart(){
      state.step = 0;
      state.currentIndex = 0;
      updateProgress();
      showScreen(screenStart);
      syncButtons();
    }

    function goToQuestion(index){
      const N = questions.length;
      state.currentIndex = clamp(index, 0, N - 1);
      state.step = state.currentIndex + 1;

      updateProgress();
      renderQuestion();
      showScreen(screenQuiz);
      syncButtons();
    }
        async function sendResultToSheets(){
      if (!SHEETS_WEBAPP_URL || SHEETS_WEBAPP_URL.includes("ВСТАВЬ_СЮДА")) return;

      const payload = {
        name: state.userName || "Без имени",
        score: state.score,
        maxScore: maxScore(),
        answers: state.answers,
        ua: navigator.userAgent
      };

      // text/plain уменьшает шанс CORS/preflight проблем
      const res = await fetch(SHEETS_WEBAPP_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify(payload)
      });

      const txt = await res.text();
      try { return JSON.parse(txt); } catch { return { ok: true, raw: txt }; }
    }


      async function goToResult(){
    state.step = questions.length + 1;
    updateProgress();
    renderResult();
    showScreen(screenResult);
    syncButtons();
    progressFill.style.width = "100%";

    try{
      await sendResultToSheets();
    }catch(e){
      console.warn("Не удалось сохранить результат в Google Sheets:", e);
    }
  }
    function resetAll(){
      state.step = 0;
      state.currentIndex = 0;
      state.answers = new Array(questions.length).fill(null);
      state.score = 0;
      goToStart();
    }
    function openReviewModal(){
      reviewModal.classList.add("active");
      reviewModal.setAttribute("aria-hidden", "false");
    }
    
    function closeReviewModal(){
      reviewModal.classList.remove("active");
      reviewModal.setAttribute("aria-hidden", "true");
    }

    // ====== Обработчики кнопок ======
    btnNext.addEventListener("click", () => {
      const N = questions.length;

            if (state.step === 0){
        const name = (userNameInput?.value || "").trim();
        if (!name){
          alert("Введите имя, чтобы сохранить результат в таблицу.");
          userNameInput?.focus();
          return;
        }
        state.userName = name;
        goToQuestion(0);
        return;
      }
      if (state.step >= 1 && state.step <= N){
        const i = state.currentIndex;
        if (!isAnswered(i)) return;

        if (i === N - 1){
          goToResult();
        } else {
          goToQuestion(i + 1);
        }
        return;
      }

      // если на результате — начать заново
      resetAll();
    });

    btnBack.addEventListener("click", () => {
      const N = questions.length;

      if (state.step === 0) return;

      if (state.step >= 1 && state.step <= N){
        const i = state.currentIndex;
        if (i === 0){
          goToStart();
        } else {
          goToQuestion(i - 1);
        }
        return;
      }

      // с результата назад — на последний вопрос
      goToQuestion(N - 1);
    });

    btnReset.addEventListener("click", () => {
      resetAll();
    });

        btnOpenReview?.addEventListener("click", openReviewModal);
    btnCloseReview?.addEventListener("click", closeReviewModal);
    
    // клик по затемнению закрывает
    reviewModal?.addEventListener("click", (e) => {
      if (e.target?.dataset?.close) closeReviewModal();
    });
    
    // Escape закрывает
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && reviewModal.classList.contains("active")) {
        closeReviewModal();
      }
    });


    // ====== Инициализация ======
    (function init(){
      // Валидация данных по минимуму
      if (!Array.isArray(questions) || questions.length === 0){
        alert("Массив questions пуст или не найден.");
        return;
      }
      updateProgress();
      syncButtons();
    })();
  </script>
    </div>
</body>
</html>








